---
title: "Visualizing subnational democracy in Colombia using Varieties of Democracy (V-Dem)"
subtitle: "Merging V-Dem responses with municipal-level data"
author: "Patrick McQuestion^[Department of Political Science & Kroc Institute, University of Notre Dame. Email: <pmcquest@nd.edu>], Michael Coppedge^[Department of Political Science, University of Notre Dame. Email: <mcoppedg@nd.edu>], Matthew Sisk^[Department of Applied and Computational Mathematics and Statistics, University of Notre Dame. Email: <msisk1@nd.edu>]"
date: "First version: February 4, 2024. This version: `r format(Sys.Date(), '%d %B %Y')`."
editor_options: 
  markdown: 
    wrap: 72
bibliography: References/BiblioRA24.bib
csl: "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/References/ajps.csl"
link-citations: yes
linkcolor: black
output: 
  pdf_document:
    latex_engine: xelatex
header-includes:
   - \usepackage{dcolumn}
   - \usepackage{setspace}
   - \doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
setwd("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq")
```

# Introduction

The objective of this methodological paper is to introduce geo-spatial
mapping of democracy at the subnational level using Varieties of
Democracy (V-Dem) data. This effort in democracy studies is data-driven
and descriptive [@coppedgeDemocratizationResearchMethods2012, 33-36]. We
describe the measurement process applied to one country (Colombia) in
order to stimulate discussion on the methodological potential for V-Dem
data to be used to measure democracy within countries. A main
contribution of this project is a systematic and applied
conceptualization of V-Dem data that can provide a granular-level
measure of subnational democracy across time.

There are obvious limitations to mapping subnational V-Dem data.
Primarily, expert interpretations of background concepts are themselves
unobservable. The dichotomous format of the questions included in the
survey are simplifications of much more contested concepts, such as
development or illicit activity. Therefore, democracy scores rely
heavily on how these concepts are interpreted by a relatively limited
number of respondents. However, mapping provides a unique method for
addressing these limitations because it integrates the use of empirical
data with V-Dem responses. The combination of continuous empirical data
with proportional responses related to the background concepts' salience
in the country can produce a composite image of subnational democracy,
and a meaningful tool for spatial analysis.

This paper introduces a process for compiling and visualizing
subnational data based on V-Dem, starting with the systematic
conceptualization of the background concepts contained in the survey,
assigning measures to those concepts on a geographic scale, and then
identifying subnational scores. We demonstrate this process for a
portion of the 21 response items in the survey.

The conclusion will discuss how these measurements could be combined or
aggregated to provide estimations of the latent concepts of electoral
fairness or civil liberty strength at the subnational level. We also
discuss future exercises in validation (i.e., expert surveys, or
comparison with other measures of subnational democracy) and replication
(i.e., applying the same process to other countries). Finally, we
suggest further exploring the causal relationships of first or second
order complexity (e.g., the correlation of subnational democracy and
development).

## Relevance

The visualization of V-Dem scores has many potential benefits for
comparative political analysis. First, this process provides a
systematic method for integrating quantitative survey data into
subnational research [@giraudyCountriesSubnationalResearch2019]. Many
approaches to measuring subnational democracy have come across spatial
dependence measurement issues
[@harbersGeoNestedAnalysisMixedMethods2017]. Rather than spatial
modeling, however, this inductive approach favors descriptive over
explanatory inference, leveraging the systematic data generating process
in V-Dem.

Rather than generating empirical data, V-Dem's subnational data
generation process captures the level of agreement among expert coders
on the relevance of within-country factors affecting democracy. These
levels of agreement are reflected in proportional scores for the
relative importance of a given variable, regardless of how the
respondent conceptualizes it. When these proportions are interacted with
the measurement of a systematized concept in geographic space, such as
Gross Domestic Product (GDP) per capita measures for economic
development in a given municipality or region, this produces unique
observational data on the salience of democracy-shaping factors. When
mapped, this creates a geographic visualization of weaker and stronger
factors affecting subnational democracy, according to country experts.

This inductive approach has benefits and limitations.

-   On the one hand, the interaction of salience with geographic data is
    descriptive rather than explanatory. It obviates the need for
    complex spatial analysis, privileging the latent nature of democracy
    as interpreted by country experts.

-   On the other hand, the estimations are heavily influenced by coder
    interpretations of complex concepts. Some respondents may lack
    confidence around a factor and respond negatively, selecting 0 to
    signify "rejection" of the category rather than decidedness that a
    factor is irrelevant.

Nonetheless, this procedure represents a meaningful and transparent
approach to measuring subnational democracy. The transparency behind
this visualization procedure provides for validation and replication
exercises. Once validated, these measures of subnational democracy can
be used to test traditional hypotheses, such as whether development
outcomes in subnational units are correlated with free and fair
elections, or with the protection of civil liberties. We can use this
data to examine the degree to which democracy is weaker or stronger in
areas with illicit activity and economic productivity, and how tightly
these variables are linked together.

# Background: V-Dem data

In the V-Dem dataset, both Elections and Civil Liberties surveys contain
four questions related to subnational democracy[^1]:

[^1]: In the dataset, these questions are labeled: `v2elsnlfc`,
    `v2elsnmrfc`, `v2clrgstch`, and `v2clrgwkch`, respectively. Note
    that while these questions are complementary, they are framed to
    elicit an open range of responses.

1.  *How would you describe the areas of the country in which elections
    are significantly less free and fair?*

2.  *How would you describe the areas of the country in which elections
    are significantly more free and fair?*

3.  *How would you describe the areas of the country where government
    officials' respect for civil liberties is significantly stronger?*

4.  *How would you describe the areas of the country where government
    officials' respect for civil liberties is significantly weaker?*

On average, a total of five country experts respond to these questions
by making dichotomous selections (0 = no, 1 = yes) across 21 individual
variables. These refer to levels of rurality, economic development,
urbanization, regional locations, civil unrest, illicit activity, sparse
populations, difficult access, indigenous areas, support for national
ruling parties, and colonial rule. Experts may also provide text
comments that clarify their selections.

The selections are then aggregated by coders to calculate the proportion
of expert responses that selected "1" for a given variable. The results
are country-year proportional scores for each variable between 0-1.
These proportional scores reflect the degree of agreement or
disagreement around the relevance of some background concepts
conditioning subnational elections or civil liberties. For example, a
proportional score of 0.8 suggests that 8 out of 10 experts agree that
more economically developed areas have stronger civil liberties.

## Uncertainty

V-Dem's subnational survey items encompass a wide range of background
concepts, from geographic features (e.g., regions) to social phenomena
(e.g., illicit activities), that may factor into or characterize
subnational democracy. The complexity of these concepts produces a high
degree of uncertainty around experts' interpretations and how they apply
to the country in question. Moreover, some dichotomized concepts in the
survey, such as "high/low economic development" or "strong/weak support
for ruling parties", are best measured by continuous variables, such as
GDP per capita or margin of victory. Respondents, however, must apply
arbitrary thresholds to dichotomize these concepts, producing simplified
generalizations.

Fundamentally, mapping subnational democracy faces many issues of
measurement validity, what @adcockMeasurementValidityShared2001
characterize as the movement between background concepts and
observations.

-   In mapping these concepts, the procedure outlined in this paper uses
    simple definitions and systematizes them by selecting one or two
    principal indicators for each response.

-   Rather than discount alternative systematizations, our objective is
    to visualize the layering of these indicators that characterize
    subnational democracy in a given context, and therefore prioritize
    reliable over valid measurements.

# Concepts, measures, and scores

This mapping procedure involves multiple stages, from the
systematization of concepts with explicit definitions, to the assignment
of measures based on coder responses, and finally the identification of
subnational "scores" based on these measures.

## Systematizing concepts

First, subnational V-Dem variables must be defined at "zero order
complexity" [@coppedgeThickeningThinConcepts1999], balancing
cross-national and context-based interpretations.

On the one hand, the cross-national nature of V-Dem surveys require the
use of general rather than specific background concepts for measurement.
For example, to assess the quality of subnational elections, the expert
survey respondent is asked to consider the impact of "economic
development" writ large across the country. The question does not
specify a definition or threshold of development. Instead, the question
allows for more than one interpretation. To ameliorate bias, the final
country-year score for this indicator is the proportion of respondents
that made the same assessment. While it may be preferable for
respondents to refer to economic data for this question, this is beyond
the scope of the survey. Moreover, without this step in generalization,
V-Dem data would be unable to produce cross-national comparative data
about the salience of attributes affecting subnational democracy.

On the other hand, country context is important for defining concepts
and selecting appropriate indicators. This occurs for both fuzzy and
less fuzzy concepts. For example, civil unrest and illicit activity are
generally contested or fuzzy concepts. Moreover, they are difficult to
observe and isolate as factors that affect democracy in the same way
across contexts, even within countries. Taking illicit activity, for
example, one area of the country with gang controlled neighborhoods may
have limited voter turnout and less free elections, while another may
tolerate or even encourage electoral competition
[@cordovaLivingGangControlledNeighborhoods2022]. Even basic
categorizations may be contested. For one expert, the North may include
10 provinces, yet for another it may include 8. Some knowledge about
these context-specific contested concepts should inform the
conceptualization process from the start, as these decisions will
ultimately shape how subnational democracy levels are mapped.

After V-Dem responses have been conceptualized for the country in
question, the operationalization of these indicators requires the use of
external (within-country) data. This may come from a wide array of
sources and formats. In Colombia, we consider the indicators as shown in
Table 1. All sources in parentheses are official government sources,
although alternative indicators and sources certainly exist.

```{r, table1, echo=FALSE, message=FALSE, results='asis'}
library(flextable)
library(dplyr)
library(officer)
library(kableExtra)

#set_flextable_defaults(fontname = "Computer Modern", fontsize = 10)

vdem_op <- data.frame(
  ID = seq(0, 16, 1), stringsAsFactors = FALSE,
  Response = c("Rural", "Urban", 
                 "Less econ devt", "More econ devt", 
                 "Inside capital", "Outside capital", 
                 "North", "South", "West", "East", 
                 "Civil unrest", "Illicit activity", 
                 "Sparse pop.", "Remote", 
                 "Indigenous", 
                 "Ruling party strong", "Ruling party weak"),
  Indicator = c("Rural Index (DANE)", "Rural Index (DANE)",
        "Mun. Value Added / Dept. GDP (DNP)", "Mun. Value Added / Dept. GDP (DNP)",
        "Geographic distance from center (DANE)", "Geographic distance from center (DANE)", 
        "Six macro-regions (DANE)", "Six macro-regions (DANE)", "Six macro-regions (DANE)", "Six macro-regions (DANE)",
        "Illegally armed groups (Min. Defense)", "Coca cultivation (Min. Defense/UNODC)",
        "Population density (DANE)", "Access (Min. Transportation/Health)",
        "Ethnic population (DANE)", 
        "Pres. margin of victory (RNEC)", "Pres. margin of victory (RNEC)"))


# Print dataframe with merged cells
vdem_op %>%
  kable("latex", escape = FALSE, caption = "Operationalization of V-Dem responses in Colombia") %>%
  kable_styling(full_width = FALSE) %>%
  collapse_rows(columns = 3, valign = "middle") %>%
  row_spec(0, bold = TRUE)


```

## Assigning measures

In order to visualize V-Dem responses in a geo-referenced environment,
the operationalized country-specific indicators must be assigned some
measure based on the proportional values recorded in each country-year.
This requires a degree of subjectivity. For example, how many votes or
proportion of votes are necessary to signify "strong" support for the
ruling party (question 15)? Or, which municipalities are considered part
of the "North" (question 6) versus the "West" (question 8)? We privilege
the use of granular data that will allow researchers flexible
interpretations of these questions, as well as subsequent validation
from country experts.

There are at least two approaches to assigning measures to V-Dem's
subnational response variables. One approach is to follow the
dichotomous nature of the survey items themselves. In this way,
municipalities would be categorized according to an arbitrary threshold,
then assigned the value recorded in V-Dem. Another approach, which we
pursue below, is to preserve the continuous nature of indicator data
when available, and calculate values based on the cumulative
distribution function (CDF) that can be interacted with V-Dem's
proportional responses.

-   Either approach will produce novel measurements at the
    municipal-level that are compatible with variables beyond the V-Dem
    indicators.

## Subnational democracy "scores"

Finally, the series of subnational V-Dem measures can be aggregated to
produce composite scores. These will provide an initial measure of
operationalized concepts, revealing geographically located "pockets" of
stronger or weaker democratization in Colombia.

-   Scoring is based on the aggregation of response values across all
    indicators. The advantage of using the CDF method is that the
    salience of each concept can be weighted to produce a final "score".

# Mapping exercise: 2018 cross-section of Colombia

This section describes in more detail a pipeline for mapping subnational
democracy, and shows how conceptualization, measurement, and scoring
occurs in practice. This exercise is designed to test the viability of
mapping cross-sectional country-level data before expanding the dataset
into panel format. Therefore, internal data from V-Dem is subset to
Colombia for 2018, and the last five subnational responses related to
foreign rule and "None of the Above" are removed because they are not
relevant for these purposes. Table 2 shows the proportional scores for
each variable, subset to Colombia in 2018, across the four survey
questions in V-Dem.

The following sections show how data from external sources is collected
and assigned 2018 V-Dem values. External data from Colombia is drawn
from a variety of sources, but we do not discount the possibility of
alternative data sources. In this exercise we also include
visualizations to demonstrate how each factor appears depending on how
V-Dem data is applied.

```{r, Vdem0, include=FALSE, echo=FALSE}
# make a clean slate
rm(list = ls())
# load needed packages
library(tidyverse)
library(vdemdata)

# Create a data frame of version 13 dataset:
v13 <- vdem
# this df appears to be the same as MC's "full + others" data set: read_dta("C:/Users/mcoppedg/Dropbox/MC/VDemFiles/Archive/V13/V-Dem-CY-Full+Others/V-Dem-CY-Full+Others-v13.dta")

# Filter to just Colombia since 1899:
v13_col <- filter(v13, country_name=="Colombia" & year > 1899)

# Select just the ID and subnational variables
# (Note: v2elsnless and v2elsnmore are not in this df. We will make sure to 
# include them in our request to the data manager.)
v13_col_sn <- v13_col %>%
  select(country_id, country_name, country_text_id, historical_date, year, 
         v2elsnlfc_0:v2elsnlfc_21, v2elsnmrfc_0:v2elsnmrfc_21,
         v2clrgstch_0:v2clrgstch_21, v2clrgwkch_0:v2clrgwkch_21)

# Listing the variable names to check our work:
#names(v13_col_sn)
# Export the result to a CSV file:
#write.csv(v13_col_sn, file = "v13_col_sn.csv")
```

```{r, v13_col_2018, include=FALSE, echo=FALSE}
# create subset of V-Dem data for 2018 
v13_col_sn_2018 <- subset(v13_col_sn, year == 2018) 
v13_col_sn_2018 <- v13_col_sn_2018 %>%
  select(-matches("_17$|_18$|_19$|_20$|_21$")) # remove responses not relevant for Colombia
df2rm = c("v13", "v13_col", "v13_col_sn", "df2rm")
rm(list = df2rm)
```

```{r, Col18-table, echo=FALSE, message=FALSE, results='asis'}

# Load necessary libraries
library(dplyr)
library(tidyr)
library(knitr)
library(purrr)
library(kableExtra)
library(insight)

selected_vars <- grep("v2elsnlfc|v2elsnmrfc|v2clrgstch|v2clrgwkch", colnames(v13_col_sn_2018), value = TRUE)
selected_df <- v13_col_sn_2018 %>%
  select(all_of(selected_vars))

summary_df <- selected_df %>%
  pivot_longer(cols = everything()) %>%
  mutate(row_id = gsub(".*_(\\d+)$", "\\1", name)) %>%
  mutate(column_id = gsub(".*(v2elsnlfc|v2elsnmrfc|v2clrgstch|v2clrgwkch).*", "\\1", name)) %>%
  pivot_wider(names_from = column_id, values_from = value) %>%
  select(-name) %>%
  mutate(row_id = as.numeric(row_id)) %>% 
  group_by(row_id) %>%
  summarise(across(everything(), ~ifelse(all(is.na(.)), NA, first(na.omit(.))))) %>%
  ungroup()

new_col_names <- c("Elections less free", "Elections more free", "Civil liberties stronger", "Civil liberties weaker")
new_row_names <- c(
  "Rural", "Urban", "Less econ devt", "More econ devt", "Inside capital", 
  "Outside capital", "North", "South", "West", "East", "Civil unrest", 
  "Illicit activity", "Sparse pop.", "Remote", "Indigenous", 
  "Ruling party strong", "Ruling party weak"
)

# Rename columns and modify row_id variable
summary_table <- summary_df %>%
  mutate(row_id = new_row_names[as.numeric(row_id) + 1]) %>%
  rename(
    `Survey variable` = row_id,
    `Elec. less free` = v2elsnlfc,
    `Elec. more free` = v2elsnmrfc,
    `Civil lib. stronger` = v2clrgstch,
    `Civil lib. weaker` = v2clrgwkch
  ) 

summary_table %>%
  kable(format = "latex", booktabs = TRUE, caption = "V-Dem response scores for Colombia in 2018") %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(0, bold = TRUE)

```

## Three stages for mapping

For the purposes of replication, we can summarize the subnational
mapping procedure into three stages.

The first stage is exploratory, identifying the level of analysis and
available data for the systematized concept in question. In this case,
we observe that Colombia has publicly available municipal-level data
dating back to at least the 1950s, at least for a relevant amount of
time-varying variables reflected in the V-Dem responses (e.g.,
population density, economic development, voting behavior, etc.). We
create a data-frame to join all data at the municipal level using
national statistics department (DANE) codes. These codes are also used
in shape-files and `.dbf` tables, such as Colombia's 2018 Census data
from DANE[^2]. For practical purposes of data collection, some
indicators (e.g., responses 6-9 that ask to identify 4 cardinal
directions) are grouped together.

[^2]: To facilitate integration of the datasets across software, we
    export the Census 2018 attribute table from ArcMaps to `.csv`
    format, then load this data into R, preserving only relevant
    variables for merging purposes. While we use DANE codes to merge
    external data using R, we use the 2018 Census variable "FID" to
    merge `.csv` files into ArcMap. This is because ArcMaps
    automatically translates some string variables (such as the DANE
    codes) into a numeric ones. For this reason, we integrate the FID
    variable for the individual `.csv` files we write. The Census data
    shape-file is useful for initial mapping visualization, containing
    not only the administrative boundaries but also contextual
    information. The
    [dictionary](https://github.com/pmcquest/snvdem24/tree/main/data/geospatial/MGN_ANM_MPIOS)
    is in the Github repository.

Second, we format the data for mapping purposes. This is a multi-step
process whereby external geolocated data must be formatted and merged
with V-Dem data. When data is continuous, as in the rurality index or
economic development measures, for example, this merging process can
take one of two forms. On the one hand, thresholds can be set to define
the areas that correspond to each background concept. On the other hand,
the data can be transformed using the cumulative distribution function
(CDF) before being merged with V-Dem values. For categorical data (e.g.,
cardinal directions) only the first option is used. The sections below
will consider both steps--thresholds and CDF--for assigning values and
creating a measure for the relative salience of factors for subnational
democracy, according to V-Dem country experts.

Finally, the responses are joined to shape-file data (`.shp`) and mapped
using Geographic Information System (GIS) software. In R or in ArcMap,
this can be done by joining data to the attribute table for the base
layer (in this case, the shape-file provided by DANE). During this stage
we create and format layers to show with less or more confidence where
free and fair elections occur (and do not occur), and where civil
liberties are stronger (or weaker), according to the respondents.

```{r, sf1, include=FALSE, echo=FALSE}
library(sf)
col <- st_read("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/BaseLayer/MGN_ANM_MPIOS.shp")
col <- col %>%
  select(1:8)
```

```{r, Arc1, include=FALSE, echo=FALSE}
library(readxl)
MGN18 <- read_excel("G:/Shared drives/snvdem/snvdem24/data/geospatial/MGN_ANM_MPIOS/MGN18.xls") 
# We select only relevant variables for merging purposes.
# colnames(MGN18)
MGN18 <- MGN18 %>%
  select(1:7)

# we merge the FID variable to our main shapefile
col <- merge(col, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
```

## 0-1: Rurality

The survey asks about elections and civil liberties in rural or urban
locations. V-Dem scores for these survey variables reflect the
proportion of respondents who selected rural, urban, or both categories
to describe election fairness and civil liberties.

Rurality or urbanization can be measured in many ways. The World Bank's
[Rural Access Index
(RAI)](https://datacatalog.worldbank.org/search/dataset/0038250) or
European Commission's [Global Human Settlement Layer
(GHSL)](https://ghsl.jrc.ec.europa.eu/CFS.php) are exemplary GIS-based
approaches. [Waldorf and Kim
(2015)](https://purr.purdue.edu/publications/2960/1) create an index
that considers population size, density, remoteness, and built-up areas.
In Colombia, [DANE
(2015)](https://colaboracion.dnp.gov.co/CDT/Estudios%20Econmicos/2015ago6%20Documento%20de%20Ruralidad%20-%20DDRS-MTC.pdf)
uses a classification based on OECD criteria that defines rural
territories as those with 150 or fewer persons per kilometer squared
($km^2$), finding that over 75% of Colombian municipalities do not meet
the threshold of 100 persons per $km^2$. From another perspective, DANE
estimates that close to 4/5 of the population lives in urban centers.

In this exercise, we take a demographic approach that considers the
proportion of the municipal rural population over the total municipal
population. This basic "Rurality Index" measure has a few advantages.
First, it was created by the Economics Center for Development and
Economy (CEDE) at Universidad de Los Andes, using official Census data
from DANE. Second, this proportional measure provides a continuous scale
of municipal rurality that can be can be interacted with the V-Dem score
proportions for the first two variables. We demonstrate this process
below.

```{r, V18_0-1_read, include=FALSE, echo=FALSE}
# municipal-level data for distance to capital city
IR18 <- read_excel("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/0-1_Rurality/PANEL_CARACTERISTICAS_GENERALES(2021).xlsx")
colnames(IR18)[3] = "MPIO_CDPMP"
colnames(IR18)[7] = "Year"
IR18 <- IR18 %>%
  filter(Year == 2018)
# this data set also contains important descriptive information (department, province) that we will hang onto
IR18 <- IR18[c("MPIO_CDPMP", "depto", "provincia", "indrural")]

# Because the import creates a numeric field for DANE code, we must convert this numeric variable to character and then assure each observation has the corresponding 5 digits
IR18$MPIO_CDPMP <- as.character(IR18$MPIO_CDPMP)
# Add a 0 before values with 4 digits only
IR18$MPIO_CDPMP <- ifelse(nchar(IR18$MPIO_CDPMP) == 4, paste0("0", IR18$MPIO_CDPMP), IR18$MPIO_CDPMP)

```

We can merge the rurality index with V-Dem scores in at least two ways.
One option is to create a threshold for rural places and assign V-Dem
scores accordingly. For example, we could take the mid-point as a
threshold for rural and urban municipalities: if more than half of the
population is considered rural inhabitants, then the municipality is
considered rural. This method provides a first cut, and may be more
intuitive to interpret. On the other hand, this approach involves the
setting of arbitrary thresholds that may produce misleading results,
especially given the cases grouped around the threshold.

Another option is to interact the rurality index with V-Dem scores and
preserve the continuous nature of the data. We call this the Cumulative
Distribution Function (CDF) approach because it creates a normalized
value for the variable that can be interacted with V-Dem scores
systematically.

```{r, V18_0-1_vdem, include=FALSE, echo=FALSE}
hist(IR18$indrural) # mostly normal, but skewed left (more rural)
# Option #1: interact V-Dem with rural index score
IR18$CDF_0t1 <- pnorm(IR18$indrural) #normal distribution, so we use pnorm (CDF)

# 0: proportion who selected Rural
IR18 <- IR18 %>% 
  mutate(el_c0 = CDF_0t1*v13_col_sn_2018$v2elsnlfc_0) %>%
  mutate(em_c0 = CDF_0t1*v13_col_sn_2018$v2elsnmrfc_0) %>%
  mutate(cs_c0 = CDF_0t1*v13_col_sn_2018$v2clrgstch_0) %>%
  mutate(cw_c0 = CDF_0t1*v13_col_sn_2018$v2clrgwkch_0)
# 1: proportion who selected Urban
IR18 <- IR18 %>% 
  mutate(el_c1 = CDF_0t1*v13_col_sn_2018$v2elsnlfc_1) %>%
  mutate(em_c1 = CDF_0t1*v13_col_sn_2018$v2elsnmrfc_1) %>%
  mutate(cs_c1 = CDF_0t1*v13_col_sn_2018$v2clrgstch_1) %>%
  mutate(cw_c1 = CDF_0t1*v13_col_sn_2018$v2clrgwkch_1)

# Option #2: categorize based on threshold, and assign the corresponding V-Dem score
# "less free and fair subnational elections"
IR18 <- IR18 %>% 
  mutate(el_d0 = case_when(
    indrural > 0.50 ~ v13_col_sn_2018$v2elsnlfc_0, # Rural areas
    TRUE ~ NA_real_)) %>%
  mutate(el_d1 = case_when(
    indrural < 0.50 ~ v13_col_sn_2018$v2elsnlfc_1, # Urban areas
    TRUE ~ NA_real_))
# "more free and fair subnational elections"
IR18 <- IR18 %>% 
  mutate(em_d0 = case_when(
    indrural > 0.50 ~ v13_col_sn_2018$v2elsnmrfc_0,
    TRUE ~ NA_real_)) %>%
  mutate(em_d1 = case_when(
    indrural < 0.50 ~ v13_col_sn_2018$v2elsnmrfc_1,
    TRUE ~ NA_real_))
# "stronger civil liberties"
IR18 <- IR18 %>% 
  mutate(cs_d0 = case_when(
    indrural > 0.50 ~ v13_col_sn_2018$v2clrgstch_0,
    TRUE ~ NA_real_)) %>%
  mutate(cs_d1 = case_when(
    indrural < 0.50 ~ v13_col_sn_2018$v2clrgstch_1,
    TRUE ~ NA_real_))
# "weaker civil liberties"
IR18 <- IR18 %>% 
  mutate(cw_d0 = case_when( 
    indrural > 0.50 ~ v13_col_sn_2018$v2clrgwkch_0, 
    TRUE ~ NA_real_)) %>%
  mutate(cw_d1 = case_when(
    indrural < 0.50 ~ v13_col_sn_2018$v2clrgwkch_1,
    TRUE ~ NA_real_))

# For sf (R), merge this data to shapefile
col <- merge(col, IR18, by = "MPIO_CDPMP", all.x = TRUE)


```

Figure 1 depicts the results of these two approaches using the question:
"How would you describe the areas of the country in which elections are
significantly less free and fair" (`v2elsnlfc`), and only looking at
option #0: Rural. On the left side is the threshold approach and on the
right side is the CDF approach. Clearly, the CDF approach provides much
more detail than the threshold approach, which can only provide a simple
visualization of areas categorized as rural. At the same time, the CDF
approach creates a new continuous measure that is less straightforward
to interpret. The CDF transforms the .875 proportion recorded in V-Dem
for this year in Colombia and, when interacted with the rurality index,
creates a variable whose municipal-level values range from
`r min(IR18$el_c0)` to `r max(IR18$el_c0)`. The benefit of using this
variable, however, is that it provides a granular, empirically grounded
estimate of the association between rurality and less free and fair
elections. Because it is a normalized measure, this new estimate can be
compared with the normalized values for other responses, resulting in a
municipal-level estimate based on V-Dem experts' assessments of the
background concept's relevance.

```{r, V18_0vdem-plot, echo=FALSE, message=FALSE, results='asis'}
library(ggplot2)
library(gridExtra)
library(stringr)

d0 <- ggplot() +
  geom_sf(data = col, aes(fill = el_d0)) + # check results
  labs(title = "0. Rural.", caption = "Threshold approach") +
  scale_fill_continuous(guide = guide_colorbar(
    title = "V-Dem (prop.)",
    title.position = "top",  # Change title position
    label.position = "right"),
    low = "lightgreen",
    high = "darkgreen") + # Change label position
  theme(legend.title = element_text(size = 6)) +
  theme_void()
c0 <- ggplot() +
  geom_sf(data = col, aes(fill = el_c0)) + # check results
  labs(title = "0. Rural.", caption = "CDF approach") +
  scale_fill_continuous(guide = guide_colorbar(
    title = "V-Dem (pnorm)",
    title.position = "top",  # Change title position
    label.position = "right"),
    low = "lightgreen",
    high = "darkgreen") + # Change label position
  theme(legend.title = element_text(size = 6)) +
  theme_void()

# Arrange the plots side by side

top_title <- element_text(face = "italic", size = 10)

arranged_plots <- grid.arrange(d0 + theme(plot.title = element_text(size = 12)), 
                               c0 + theme(plot.title = element_text(size = 12)), 
                               top = "How would you describe the areas of the country in which elections are significantly less free and fair?",
                               ncol = 2)
suppressMessages(arranged_plots)

```

```{r, V18_0-1_export, include=FALSE, echo=FALSE}

# merge base-layer dataset to obtain FID variable
IR18 <- merge(IR18, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
IR18 <- IR18 %>%
  rename(indrur0t1 = indrural) %>%
  rename(FID_0t1 = FID)

# For ArcMaps, export the final merge to a .csv file
write.csv(IR18, file = "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/0-1_Rurality/IR18_0-1.csv", row.names = FALSE)

#clean things up for next variable
df2rm = c("IR18", "df2rm", "arranged_plots", "c0", "d0")
rm(list = df2rm)

```

Of course, these composite municipal-level scores are heavily skewed by
how the concept is systematized. In this example, we used a demographic
measure--the rurality index--that relies on Census-defined parameters of
what constitutes a rural inhabitant or not. Census measures may vary
across countries, so the use of this measure may limit its use for
cross-national comparative analysis. Nonetheless, as opposed to the
threshold approach, the CDF approach takes advantage of the continuous
nature of available data. Robustness checks using other continuous
measures of rurality or urbanization would provide more confidence in
the CDF approach going forward.

## 2-3: Economic development

Another advantage of the CDF approach is that it provides a
straightforward method for V-Dem data to be scaled at different levels.
This can be helpful when statistical data are missing at one level but
not at another, or when respondents are likely to have multiple
alternative interpretations. By contrast, the setting of arbitrary
thresholds makes it difficult to scale data or to compare across
measures.

In this section, we consider two measures of "economic development," a
variable that appears in the V-Dem survey under responses 2 ("Areas that
are less economically developed") and 3 ("Areas that are more
economically developed"), using multiple levels of analysis. This
demonstrates how the CDF approach applied to economic and V-Dem data can
provide a flexible tool for understanding multidimensional phenomena
with many possible interpretations and comparable measures.

A common measure of economic development is GDP per capita, however this
measure is problematic when scaled down to the subnational level.
Indeed, according to DANE, only 41 countries in the world calculate
regional or subnational GDP [@buenasp2020]. The difficulty may stem from
the complex task of isolating economic productivity for subnational
units when inhabitants may be undertaking inter-municipal daily
commutes, for example, or when supply-chains overlap with multiple
departmental jurisdictions. DANE provides subnational data for GDP (or
Producto Bruto Interno, PBI, in Spanish) at regional and departmental
(provincial) levels, but not at the municipal level. They calculate a
historical "retropolation" of departmental GDP dating back to 1980.[^3]

[^3]: Most departments are covered by the retropolation measure, but
    newer departments (many of which were inducted in 1991) are grouped
    into one unit, and therefore cannot be mapped based on DANE's
    Departmental Code system without data intervention. These are:
    Amazonas (91), Arauca (81), Casanare (85), Guainía (94), Guaviare
    (95), Putumayo (86), San Andrés, Providencia y Santa Catalina
    (Archipiélago) (88), Vaupés (97) y Vichada (99).

At the municipal-level, DANE has created a measure of municipal "value
added", which estimates the relative economic capacity of municipalities
within each department by subtracting consumption levels from gross
production (methodological documentation is included in the
[repository](https://github.com/pmcquest/snvdem24/tree/main/data/geospatial/2018pmq/2-3_EconDevt/biblio)).
Nearly all municipalities are measured by the Municipal Value Added
(VAM) measure, however, data only exists from 2011 onward. It may be
possible that V-Dem country experts are attuned to the economic
disparities occurring within departments, and are considering how these
affect electoral dynamics or civil liberties when responding to the
subnational survey questions.

```{r, V18_2-3_read, include=FALSE, echo=FALSE}
# municipal-level data for "value added"
VAM18 <- read_excel("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/2-3_EconDevt/anexo-2020-2021-provisional-valor-agregado-municipio-2011-2021.xlsx", sheet = "Cuadro 9", range = "A11:I1133")
# rename columns to facilitate merging shapefile
VAM18 <- VAM18 %>%
  rename(MPIO_CDPMP = `Código Municipio`) %>%
  rename(DPTO_CCDGO = `Código Departamento`) %>%
  rename(VAM18_2t3 = `Valor agregado\r\n`) %>%
  select(1|3|8)

# merge base-layer dataset to obtain FID variable (for later integration with ArcMaps)
ED18 <- merge(VAM18, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
ED18 <- ED18 %>%
  rename(FID_2t3 = FID)

# department-level data for "PBI per capita"
PBID <- read_excel("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/2-3_EconDevt/anex-PIBDep-RetropolacionDepartamento-2022pr.xlsx", sheet = "Cuadro 1", range = "A10:AS36")
PBID <- PBID %>%
  rename(DPTO_CCDGO = `Código Departamento (DIVIPOLA)`) %>%
  select(DPTO_CCDGO, `2018`) %>% #keep only 2018 data 
  rename(PBID18_2t3 = `2018`)

ED18 <- merge(ED18, PBID, by = "DPTO_CCDGO", all.x = TRUE)

```

After compiling these data from DANE at municipal and departmental
levels, we interact each of these measures with the V-Dem responses, as
we did with rurality. Because data for both measures are continuous but
not proportional, we must create new variables capturing the
proportional weight for each department and municipality. Departmental
GDP and municipal VAM data include outliers, especially at the municipal
level. Because data is not normally distributed, we use the
non-parametric empirical cumulative distribution (ECDF) function to
scale them.

```{r, V18_2-3_vdem, include=FALSE, echo=FALSE}
hist(ED18$PBID18_2t3) #right-skewed, major outlier is Bogota (25% of Colombian GDP and VAM), so the data could be logged
hist(ED18$VAM18_2t3) # heavily skewed by few cases with much higher values
# Because the data is not normally distributed, we use the Empirical CDF
eCDF_2t3d <- ecdf(ED18$PBID18_2t3) 
ED18$eCDF_2t3d <- eCDF_2t3d(ED18$PBID18_2t3) # departments
eCDF_2t3m <- ecdf(ED18$VAM18_2t3)
ED18$eCDF_2t3m <- eCDF_2t3m(ED18$VAM18_2t3) # municipalities


# Option #1: interact V-Dem with ECDF variables
# Department-level data
# 2: proportion who selected less economically developed
ED18 <- ED18 %>% 
  mutate(el_c2d = eCDF_2t3d*v13_col_sn_2018$v2elsnlfc_2) %>%
  mutate(em_c2d = eCDF_2t3d*v13_col_sn_2018$v2elsnmrfc_2) %>%
  mutate(cs_c2d = eCDF_2t3d*v13_col_sn_2018$v2clrgstch_2) %>%
  mutate(cw_c2d = eCDF_2t3d*v13_col_sn_2018$v2clrgwkch_2)
# 3: proportion who selected more economically developed
ED18 <- ED18 %>% 
  mutate(el_c3d = eCDF_2t3d*v13_col_sn_2018$v2elsnlfc_3) %>%
  mutate(em_c3d = eCDF_2t3d*v13_col_sn_2018$v2elsnmrfc_3) %>%
  mutate(cs_c3d = eCDF_2t3d*v13_col_sn_2018$v2clrgstch_3) %>%
  mutate(cw_c3d = eCDF_2t3d*v13_col_sn_2018$v2clrgwkch_3)
# Municipal-level data
# 2: proportion who selected less economically developed
ED18 <- ED18 %>% 
  mutate(el_c2m = eCDF_2t3m*v13_col_sn_2018$v2elsnlfc_2) %>%
  mutate(em_c2m = eCDF_2t3m*v13_col_sn_2018$v2elsnmrfc_2) %>%
  mutate(cs_c2m = eCDF_2t3m*v13_col_sn_2018$v2clrgstch_2) %>%
  mutate(cw_c2m = eCDF_2t3m*v13_col_sn_2018$v2clrgwkch_2)
# 3: proportion who selected more economically developed
ED18 <- ED18 %>% 
  mutate(el_c3m = eCDF_2t3m*v13_col_sn_2018$v2elsnlfc_3) %>%
  mutate(em_c3m = eCDF_2t3m*v13_col_sn_2018$v2elsnmrfc_3) %>%
  mutate(cs_c3m = eCDF_2t3m*v13_col_sn_2018$v2clrgstch_3) %>%
  mutate(cw_c3m = eCDF_2t3m*v13_col_sn_2018$v2clrgwkch_3)

# For sf (R), merge this data to shapefile
col <- merge(col, ED18, by = "MPIO_CDPMP", all.x = TRUE)

```

To demonstrate how the CDF approach facilitates scaling and comparison
of V-Dem data at the subnational level, Figure 2 visualizes both
measures for 2018. Clearly, there is missing data at the departmental
level for the GDP measure given the presence of newer departments. Obviously, departmental GDP shows less variation than the municipal-level VAM measure.
Nonetheless, there are some similarities around the center and western parts of the
country across both measures. 

The comparison shows that depending on the scale of the data and the economic measures used, one could reach different conclusions about experts' confidence around development levels and electoral fairness. Indeed, the northern region displays considerable
divergence in V-Dem levels depending on the scale being used. On the
other hand, the port city of Buenaventura on the Pacific coast is consistent across both
scales. 

To be sure, these visualizations provide a limited quantitative measure 
of V-Dem country experts' assessment of electoral fairness and economic development using the ECDF method. Additional quantitative and qualitative data from entities like the
Election Observation Mission (MOE), for example, would provide additional
analysis of electoral dynamics across the country that can further
contextualize the role of economic development subnationally
[@barrioscabreraMapasFactoresRiesgo2018].

```{r, V18_2-3vdem-plot, echo=FALSE, message=FALSE, results='asis'}

c3d <- ggplot() +
  geom_sf(data = col, aes(fill = em_c3d)) + # check results
  labs(title = "3. Areas that are more economically developed", caption = "Department GDP (PBI departamental)") + 
  scale_fill_continuous(guide = guide_colorbar(
    title = "V-Dem (ecdf)",
    title.position = "top",  # Change title position
    label.position = "right"),
    low = "lightblue",
    high = "darkblue") + # Change label position
  theme(legend.title = element_text(size = 6)) +
  theme_void()
c3m <- ggplot() +
  geom_sf(data = col, aes(fill = em_c3m)) + # check results
  labs(title = "3. Areas that are more economically developed", caption = "Municipal Value Added (VAM)") +
  scale_fill_continuous(guide = guide_colorbar(
    title = "V-Dem (ecdf)",
    title.position = "top",  # Change title position
    label.position = "right"),
    low = "lightblue",
    high = "darkblue") + # Change label position
  theme(legend.title = element_text(size = 6)) +
  theme_void()

# Arrange the plots side by side
arranged_plots2 <- grid.arrange(c3d + theme(plot.title = element_text(size = 10)), 
                                c3m + theme(plot.title = element_text(size = 10)), 
                                top = "How would you describe the areas of the country in which elections are significantly more free and fair?",
                                ncol = 2)

suppressMessages(arranged_plots2)

```

```{r, V18_2-3_export, include=FALSE, echo=FALSE}
# For sf (R), merge this data to shapefile
# but first drop the DPTO variable
ED18_2t3 <- subset(ED18, select = -DPTO_CCDGO)
col <- merge(col, ED18_2t3, by = "MPIO_CDPMP", all.x = TRUE)

# For ArcMap, export V-Dem merged data to a .csv file that will be joined to map
write.csv(ED18_2t3, file = "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/2-3_EconDevt/ED18_2-3.csv", row.names = FALSE)

#clean things up for next variable
df2rm = c("ED18", "ED18_2t3", "PBID", "VAM18", "df2rm")
rm(list = df2rm)
```

## 4-5: Inside or outside of capital city

The comparative approach can also be used to examine divergences in the degree of confidence across more or less free elections, or stronger or weaker civil liberties, given empirical data. 

The survey asks about elections and civil liberties "Inside / Outside
the capital city" (responses 4 and 5). In the context of the V-Dem
survey, which is cross-national, respondents may reasonably interpret this question to refer to the national capital (Bogota). University of Los Andes Center for Studies
on Economic Development (CEDE) provides a measure for this variable for which we can merge V-Dem data using the CDF approach. 

```{r, V18_4-5_read, include=FALSE, echo=FALSE}
# municipal-level data for distance to capital city
CEDE18 <- read_excel("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/4-5_DisCapital/PANEL_CARACTERISTICAS_GENERALES(2021).xlsx")
colnames(CEDE18)[3] = "MPIO_CDPMP"
colnames(CEDE18)[7] = "Year"
CEDE18 <- CEDE18 %>%
  filter(Year == 2018)
# this data set also contains important descriptive information (department, province, rurality index) that we will hang onto
CEDE18 <- CEDE18[c("MPIO_CDPMP", "discapital", "disbogota")]

# Because the import creates a numeric field for DANE code, we must convert this numeric variable to character and then assure each observation has the corresponding 5 digits
CEDE18$MPIO_CDPMP <- as.character(CEDE18$MPIO_CDPMP)
# Add a 0 before values with 4 digits only
CEDE18$MPIO_CDPMP <- ifelse(nchar(CEDE18$MPIO_CDPMP) == 4, paste0("0", CEDE18$MPIO_CDPMP), CEDE18$MPIO_CDPMP)

# Note: It may be possible to calculate this variable in ArcMaps using the field calculator, but this requires advanced techniques.

```

Although the survey asks two questions, the first ("Inside the capital city") is one extreme of the second ("Outside"), so we create one continuous variable that reflects the relative proximity of municipalities from Bogota.


```{r, V18_4-5_vdem-dicho, include=FALSE, echo=FALSE}
# National capital:
# "less free and fair subnational elections"
CEDE18 <- CEDE18 %>% 
  mutate(el_4t5n = case_when(
    disbogota == 0 ~ v13_col_sn_2018$v2elsnlfc_4,  
    disbogota > 0 ~ v13_col_sn_2018$v2elsnlfc_5,
    TRUE ~ NA_real_
))
# "more free and fair subnational elections"
CEDE18 <- CEDE18 %>% 
  mutate(em_4t5n = case_when(
    disbogota == 0 ~ v13_col_sn_2018$v2elsnmrfc_4,
    disbogota > 0 ~ v13_col_sn_2018$v2elsnmrfc_5,
    TRUE ~ NA_real_ 
))
# "stronger civil liberties"
CEDE18 <- CEDE18 %>% 
  mutate(cs_4t5n = case_when(
    disbogota == 0 ~ v13_col_sn_2018$v2clrgstch_4, 
    disbogota > 0 ~ v13_col_sn_2018$v2clrgstch_5,
    TRUE ~ NA_real_
))
# "weaker civil liberties"
CEDE18 <- CEDE18 %>% 
  mutate(cw_4t5n = case_when( 
    disbogota == 0 ~ v13_col_sn_2018$v2clrgwkch_4,  
    disbogota > 0 ~ v13_col_sn_2018$v2clrgwkch_5,
TRUE ~ NA_real_
))

# Department capital:
# "less free and fair subnational elections"
CEDE18 <- CEDE18 %>% 
  mutate(el_4t5d = case_when(
    discapital == 0 ~ v13_col_sn_2018$v2elsnlfc_4,  
    discapital > 0 ~ v13_col_sn_2018$v2elsnlfc_5,
    TRUE ~ NA_real_
))
# "more free and fair subnational elections"
CEDE18 <- CEDE18 %>% 
  mutate(em_4t5d = case_when(
    discapital == 0 ~ v13_col_sn_2018$v2elsnmrfc_4,
    discapital > 0 ~ v13_col_sn_2018$v2elsnmrfc_5,
    TRUE ~ NA_real_ 
))
# "stronger civil liberties"
CEDE18 <- CEDE18 %>% 
  mutate(cs_4t5d = case_when(
    discapital == 0 ~ v13_col_sn_2018$v2clrgstch_4, 
    discapital > 0 ~ v13_col_sn_2018$v2clrgstch_5,
    TRUE ~ NA_real_
))
# "weaker civil liberties"
CEDE18 <- CEDE18 %>% 
  mutate(cw_4t5d = case_when( 
    discapital == 0 ~ v13_col_sn_2018$v2clrgwkch_4,  
    discapital > 0 ~ v13_col_sn_2018$v2clrgwkch_5,
TRUE ~ NA_real_
))
```

```{r, V18_4-5_vdem-scale, include=FALSE, echo=FALSE}

# continuous scale
range(CEDE18$disbogota) #1270.85 is furthest distance
CEDE18$pct_4t5x <- CEDE18$disbogota / 1270.85 #create a proportional score of distance from Bogota 

CEDE18 <- CEDE18 %>% 
  mutate(el_4t5x = ((1-pct_4t5x)*v13_col_sn_2018$v2elsnlfc_4)+(pct_4t5x*v13_col_sn_2018$v2elsnlfc_5)) %>%
  mutate(em_4t5x = ((1-pct_4t5x)*v13_col_sn_2018$v2elsnmrfc_4)+(pct_4t5x*v13_col_sn_2018$v2elsnmrfc_5)) %>%
  mutate(cs_4t5x = ((1-pct_4t5x)*v13_col_sn_2018$v2clrgstch_4)+(pct_4t5x*v13_col_sn_2018$v2clrgstch_5)) %>%
  mutate(cw_4t5x = ((1-pct_4t5x)*v13_col_sn_2018$v2clrgwkch_4)+(pct_4t5x*v13_col_sn_2018$v2clrgwkch_5))

# Min-max normalization function
nz <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}
# Create new variables with normalized values. Normalization may be important when comparing across variable scales.
df_nz <- data.frame(el_4t5xs = nz(CEDE18$el_4t5x),
                    em_4t5xs = nz(CEDE18$em_4t5x),
                    cs_4t5xs = nz(CEDE18$cs_4t5x),
                    cw_4t5xs = nz(CEDE18$cw_4t5x))
# Combine the normalized variables with the original dataframe
CEDE18 <- cbind(CEDE18, df_nz)

# For sf (R), merge this data to shapefile
col <- merge(col, CEDE18, by = "MPIO_CDPMP", all.x = TRUE)
```

```{r, V18_4-5_vdem-plot, include=FALSE, echo=FALSE}

ggplot() +
  geom_sf(data = col, aes(fill = el_4t5x)) + # just to check results
  scale_fill_viridis_c() +  # Adjust color scale as needed
  theme_minimal()

```

```{r, V18_4-5_export, include=FALSE, echo=FALSE}
# For sf (R), merge this data to shapefile
col <- merge(col, CEDE18, by = "MPIO_CDPMP", all.x = TRUE)


# merge base-layer dataset to obtain FID variable
CEDE18 <- merge(CEDE18, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
CEDE18 <- CEDE18 %>%
  rename(discap4t5 = discapital) %>%
  rename(disbog4t5 = disbogota) %>% 
  rename(FID_4t5 = FID)

# For ArcMaps, export the final merge to a .csv file
write.csv(CEDE18, file = "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/4-5_DisCapital/DC18_4-5.csv", row.names = FALSE)

#clean things up for next variable
df2rm = c("CEDE18", "df2rm")
rm(list = df2rm)

```

## 6-9: Cardinal directions

In order to map the four cardinal regions in Colombia, we are guided by
external data from DANE who recently classified the country into 6
[macro-regions](https://www.dane.gov.co/index.php/estadisticas-por-tema/informacion-regional/informacion-estadistica-desagregada-con-enfoque-territorial-y-diferencial/informacion-del-dane-para-la-toma-de-decisiones-en-departamentos-y-ciudades-capitales).
We find a public-access table of municipalities classified into these
regions
[here](https://www.datos.gov.co/Mapas-Nacionales/Departamentos-y-municipios-de-Colombia/xdk5-pm3f/about_data).
There are other divisions, such as the 5 regions used by CEDE studies
(Andina, Caribe, Pacifica, Orinoquia, Amazonia), but for now we go with
the prior classification.

```{r, V18_6-9_read, include=FALSE, echo=FALSE}
#data from DANE regions requires some formatting before merging
reg <- read_csv("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/6-9_Cardinal/Departamentos_y_municipios_de_Colombia_20240312.csv")
reg <- reg %>%
  rename(mpio = `CÓDIGO DANE DEL MUNICIPIO`)
reg$MPIO_CDPMP <- sprintf("%.3f", reg$mpio) #Codigo municipio should have 5 digits
reg$MPIO_CDPMP <- gsub("\\.", "", reg$MPIO_CDPMP)
reg$MPIO_CDPMP <- ifelse(nchar(reg$MPIO_CDPMP) == 4, sprintf("0%s", reg$MPIO_CDPMP), reg$MPIO_CDPMP)

```

We decide to group the regions in the following manner (see code below),
creating a new variable called "Cardinal". Then, we merge our V-Dem data
related to responses #6-9 for each subnational survey question.

```{r, V18_6-9_vdem, include=FALSE, echo=FALSE}
unique(reg$REGION)
reg <- reg %>%
  mutate(Cardinal = case_when(
    REGION %in% c('Región Caribe', 'Región Eje Cafetero - Antioquia') ~ 'North',
    REGION %in% c('Región Centro Oriente', 'Región Llano') ~ 'East',
    REGION == 'Región Centro Sur' ~ 'South',
    REGION == 'Región Pacífico' ~ 'West',
    TRUE ~ NA_character_
  ))

# V-Dem merge:
# "less free and fair subnational elections"
reg <- reg %>% 
  mutate(elsnlfc = case_when(
    Cardinal == "North" ~ v13_col_sn_2018$v2elsnlfc_6,  
    Cardinal == "South" ~ v13_col_sn_2018$v2elsnlfc_7,
    Cardinal == "West" ~ v13_col_sn_2018$v2elsnlfc_8,  
    Cardinal == "East" ~ v13_col_sn_2018$v2elsnlfc_9,
    TRUE ~ NA_real_ 
))
# "more free and fair subnational elections"
reg <- reg %>% 
  mutate(elsnmrfc = case_when(
    Cardinal == "North" ~ v13_col_sn_2018$v2elsnmrfc_6,
    Cardinal == "South" ~ v13_col_sn_2018$v2elsnmrfc_7,
    Cardinal == "West" ~ v13_col_sn_2018$v2elsnmrfc_8,  
    Cardinal == "East" ~ v13_col_sn_2018$v2elsnmrfc_9,
    TRUE ~ NA_real_ 
))
# "stronger civil liberties"
reg <- reg %>% 
  mutate(clrgstch = case_when(
    Cardinal == "North" ~ v13_col_sn_2018$v2clrgstch_6, 
    Cardinal == "South" ~ v13_col_sn_2018$v2clrgstch_7,
    Cardinal == "West" ~ v13_col_sn_2018$v2clrgstch_8,  
    Cardinal == "East" ~ v13_col_sn_2018$v2clrgstch_9,
    TRUE ~ NA_real_
))
# "weaker civil liberties"
reg <- reg %>% 
  mutate(clrgwkch = case_when( 
    Cardinal == "North" ~ v13_col_sn_2018$v2clrgwkch_6,  
    Cardinal == "South" ~ v13_col_sn_2018$v2clrgwkch_7,
    Cardinal == "West" ~ v13_col_sn_2018$v2clrgwkch_8,  
    Cardinal == "East" ~ v13_col_sn_2018$v2clrgwkch_9,
TRUE ~ NA_real_ 
))

# Select and rename variables
reg <- reg %>% 
  select(1|6:11) %>%
  rename(Card_6t9 = Cardinal) %>%
  rename(elsnl_6t9 = elsnlfc) %>%
  rename(elsnmr_6t9 = elsnmrfc) %>%
  rename(clrgst_6t9 = clrgstch) %>%
  rename(clrgwk_6t9 = clrgwkch)

```

```{r, V18_6-9_export, include=FALSE, echo=FALSE}

# For sf (R), merge this data to shapefile
col <- merge(col, reg, by = "MPIO_CDPMP", all.x = TRUE)

# For ArcMaps, merge base-layer dataset to obtain FID variable (for later integration with ArcMaps)
reg <- merge(reg, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
reg <- reg %>% 
  rename(FID_6t9 = FID)
#Belen de Bajira (Choco) does not have an FID number, which causes problems in ArcMap when merging. This municipality was only recently inaugurated.
reg <- reg[complete.cases(reg$FID_6t9), ] 

# Export the final merge to a .csv file that can be read into ArcMaps:
write.csv(reg, file = "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/6-9_Cardinal/CD18_6-9.csv", row.names = FALSE)

#clean things up for next variable
df2rm = c("reg", "df2rm")
rm(list = df2rm)

```

## 10: Civil unrest

## 11: Illicit activity

## 12: Sparse population density

-   will likely covary with rurality

## 13: Remoteness

-   will likely covary with rurality

## 14: Indigenous

## 15-16: National ruling party

The questions ask "Areas where national ruling party or group is strong
/ weak." The most straightforward measure is a dichotomous variable
where president receives a majority of the vote or not. A more
variegated measure can leverage the percentage of votes cast for the
president-elect vs. runner-up, for example, however this measure may
need to account for blank votes (which may signify protest votes).

The measure for ruling party support used here will be: % of vote that
supports ruling party. For first wrangle, I will choose 2018 runoff
election (second round) between Petro and Duque (Duque won, so his is
ruling party). This makes things easier because there are only 2
candidates, the winner and runner-up. Elections without second rounds
(prior to 1994, as well as 2002 and 2006) may require additional coding.

```{r, V18_15-16_read, include=FALSE, echo=FALSE}
# Import voting data from Registraduria (RNEC).
library(readr)
rp18 <- read_csv("G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/15-16_RulingParty/2018_presidencia_segunda_vuelta_dta_c27d4515ed.csv") # this long dataset contains only 2 candidates because it was a second-round election. other datasets will include more rows depending on the number of candidates running.

#Codigo municipio should have 5 digits
rp18$MPIO_CDPMP <- as.character(rp18$codmpio)
rp18$MPIO_CDPMP <- ifelse(nchar(rp18$MPIO_CDPMP) == 4, sprintf("0%s", rp18$MPIO_CDPMP), rp18$MPIO_CDPMP)
# merge base-layer dataset to obtain FID variable (for later integration with ArcMaps)
rp18 <- merge(rp18, MGN18[, c("MPIO_CDPMP", "FID")], by = "MPIO_CDPMP", all.x = TRUE)
```

The voting data requires more steps for cleaning. In this exercise, we
will take all possible vote entries: top 2 candidates, as well as no
mark, blank, or null ballots. We see that Duque won by high margin (over
26% on average) in 2018.

```{r, V18_15-16_edit, include=FALSE, echo=FALSE}
library(dplyr)
# Step 1: Calculate total votes cast at municipal level (allows for percentages later on).
rp18 <- rp18 %>%
  group_by(FID) %>%
  mutate(votototal = sum(votos)) %>%
  mutate(vtpc = votos/votototal) %>% #optional: useful for quick look at percentages, SD, etc. 
  mutate(vtpc0 = round(vtpc*100, 2)) 

# For mapping at the municipal level, values may take the form of: percent difference in votes between top winner and runner-up candidate(s). This requires a few steps:

#Step 2: Pivot municipal voting behavior into wide format.
p18d0 <- rp18 %>%
  group_by(FID, codigo_lista) %>%
  pivot_wider(names_from = codigo_lista, values_from = votos) %>% # Pivot to wide format
  rename(Petro = `1`,
         Duque = `2`,
         nomark = `997`,
         null = `998`,
         blank = `999`)

## Step 3: Create new dfs for voting behavior at municipal level -- is there a more efficient code?
p18d2 <- p18d0 %>%
  select(FID, Petro) %>%
  filter(!is.na(Petro))
p18d2 <- p18d2[!duplicated(p18d2$FID), ]
p18d3 <- p18d0 %>%
  select(FID, Duque) %>%
  filter(!is.na(Duque))
p18d3 <- p18d3[!duplicated(p18d3$FID), ]
p18d4 <- p18d0 %>%
  select(FID, nomark) %>%
  filter(!is.na(nomark))
p18d4 <- p18d4[!duplicated(p18d4$FID), ]
p18d5 <- p18d0 %>%
  select(FID, null) %>%
  filter(!is.na(null))
p18d5 <- p18d5[!duplicated(p18d5$FID), ]
p18d6 <- p18d0 %>%
  select(FID, blank) %>%
  filter(!is.na(blank))
p18d6 <- p18d6[!duplicated(p18d6$FID), ]
p18d7 <- p18d0 %>%
  group_by(FID) %>%
  summarise(vtotal = first(votototal))
p18d7 <- p18d7[!duplicated(p18d7$FID), ]

RPs <- list(p18d2, p18d3, p18d4, p18d5, p18d6, p18d7)
merged_RP <- Reduce(function(x, y) merge(x, y, by = "FID", all = TRUE), RPs)

df2rm2 = c("rp18", "p18d0", "p18d2", "p18d3", "p18d4", "p18d5", "p18d6", "p18d7", "df2rm2", "RPs")
rm(list = df2rm2)

## Step 3: Create margin of support variable for winner and runner-up candidates. Positive value indicates support for winner; negative indicates opposition. Variable order may vary depending on the election year data from RNEC
RP_15 <- merged_RP %>%
  mutate(MOV_top2 = Duque-Petro) %>% #Raw vote-count margin of victory
  mutate(Duque_pct = Duque/vtotal) %>%
  mutate(Petro_pct = Petro/vtotal) %>%
  mutate(MOV_pct = Duque_pct-Petro_pct) #Standardized percent margin of victory

```

After creating the data frame for voting behavior at the municipal
level, we must decide on the threshold for "strong" versus "weak"
support of the ruling party. We could take one standard deviation or
higher as the threshold, but even so: what is the criteria? In the
interest of simplicity, we will create a dichotomous measure, with
margin of victory (MOV) above 10 percentage points, applied in either
direction (positive for winner Duque; negative for loser Petro). This
seems like a standard difference, but further research could guide this
threshold setting. - ideally, don't dichotomize. Use a continuous
scale. - cl stronger where RP is stronger and experts agree thats

```{r, V18_15-16_vdem, include=FALSE, echo=FALSE}
mean(RP_15$MOV_top2_pct) #Duque margin is 26.3% on average (quite high).
sd(RP_15$MOV_top2_pct) #SD for the margin is larger than the mean (39.7%) suggesting abnormal distribution
hist(RP_15$MOV_pct, main = "Histogram of MOV", xlab = "MOV", col = "skyblue", border = "black") #left-tail long (margin for Petro)


#Q15: in "areas where support [10% MOV] for the national ruling party is strong" there are ...
## instead of arbitrary cut-point
RP_15 <- RP_15 %>% 
  #"less free and fair subnational elections" 
  mutate(elsnl_15 = case_when(
    MOV_pct > 0.10 ~ v13_col_sn_2018$v2elsnlfc_15, TRUE ~ NA_real_)) %>%
  #"more free and fair subnational elections"
  mutate(elsnmr_15 = case_when(
    MOV_pct > 0.10 ~ v13_col_sn_2018$v2elsnmrfc_15, TRUE ~ NA_real_)) %>%
  #"stronger civil liberties" 
  mutate(clrgst_15 = case_when(
    MOV_pct > 0.10 ~ v13_col_sn_2018$v2clrgstch_15, TRUE ~ NA_real_)) %>%
  #"weaker civil liberties" 
  mutate(clrgwk_15 = case_when(
    MOV_pct > 0.10 ~ v13_col_sn_2018$v2clrgwkch_15, TRUE ~ NA_real_))

#Q16: in "areas where support [10% MOV] for the national ruling party is weak" there are ...
RP_15 <- RP_15 %>% 
  #"less free and fair subnational elections" 
  mutate(elsnl_16 = case_when(
    MOV_pct < -0.10 ~ v13_col_sn_2018$v2elsnlfc_16, TRUE ~ NA_real_)) %>%
  #"more free and fair subnational elections"
  mutate(elsnmr_16 = case_when(
    MOV_pct < -0.10 ~ v13_col_sn_2018$v2elsnmrfc_16, TRUE ~ NA_real_)) %>%
  #"stronger civil liberties" 
  mutate(clrgst_16 = case_when(
    MOV_pct < -0.10 ~ v13_col_sn_2018$v2clrgstch_16, TRUE ~ NA_real_)) %>%
  #"weaker civil liberties" 
  mutate(clrgwk_16 = case_when(
    MOV_pct < -0.10 ~ v13_col_sn_2018$v2clrgwkch_16, TRUE ~ NA_real_))

RP_15 <- RP_15[complete.cases(RP_15$FID), ] # remove NA case



```

```{r, V18_15-16_export, include=FALSE, echo=FALSE}

# Export the final merge to a .csv file that can be read into ArcMaps
RP18_15t16 <- RP_15 %>% 
  select(1:3|7|11:19) %>%
  rename(FID_15t16 = FID) %>%
  rename(Petro_15t16 = Petro) %>%
  rename(Duque_15t16 = Duque) %>%
  rename(vtotal_15t16 = vtotal) %>%
  rename(MOV18_15t16 = MOV_pct) %>%
  mutate(MOV18_15t16 = round(MOV18_15t16, 5))
#Belen de Bajira (Choco) does not have an FID number, which causes problems in ArcMap when merging. This municipality was only recently inaugurated.
RP18_15t16 <- RP18_15t16[complete.cases(RP18_15t16$FID_15t16), ]
# Export data to a csv file that will be joined to map
write.csv(RP18_15t16, file = "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/15-16_RulingParty/RP18_15-16.csv", row.names = FALSE)

```

## Exporting data

Mapping data can be exported to a shapefile then imported into `sf` or
ArcMap

```{r, sf_write, include=FALSE, echo=FALSE}
#st_write(col, "G:/Shared drives/snvdem/snvdem24/data/geospatial/2018pmq/MGN_2018r.shp")

```

# Conclusion

# References
